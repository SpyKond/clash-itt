<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–æ—Å—Ç–∞–≤—ã</title>
    <style>
        body { background: #050505; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        /* –°–µ—Ç–∫–∞ –¥–ª—è 8 —Å–ª–æ—Ç–æ–≤ */
        .active-deck-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
            width: 95%; max-width: 500px; background: #111; padding: 15px; 
            border-bottom: 2px solid #333; margin-top: 10px;
        }
        .slot { 
            aspect-ratio: 2/3; border: 2px dashed #444; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: #555;
            transition: 0.2s;
        }
        .slot.filled { border: 2px solid #00fbff; background: #002b2e; color: white; border-style: solid; }

        /* –ö–æ–ª–ª–µ–∫—Ü–∏—è */
        .collection-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
            gap: 10px; width: 95%; max-width: 600px; padding: 20px;
        }
        .card { 
            background: #1a1a1a; border: 2px solid #333; border-radius: 8px; 
            padding: 8px; text-align: center; cursor: grab; position: relative;
            touch-action: none; /* –í–∞–∂–Ω–æ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –ø–∞–ª—å—Ü–µ–º */
            z-index: 10;
        }
        .card.dragging { opacity: 0.5; cursor: grabbing; z-index: 1000; }
        .card.in-deck { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        
        .rat { position: absolute; top: 2px; left: 4px; font-weight: bold; color: gold; font-size: 12px; }
        .btn-back { margin-top: 15px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 8px; }
    </style>
</head>
<body>

    <button class="btn-back" onclick="window.location.href='index.html'">–í –ú–ï–ù–Æ</button>

    <div class="active-deck-grid" id="deck-slots"></div>

    <h4 style="margin: 15px 0 0 0; color: #666; text-transform: uppercase; font-size: 12px;">–¢–≤–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è (—Ç—è–Ω–∏ –∫–∞—Ä—Ç—É –≤ —Å–ª–æ—Ç)</h4>
    <div class="collection-grid" id="collection-grid"></div>

    <script>
        let collection = JSON.parse(localStorage.getItem('my_collection') || "[]");
        let activeDeck = JSON.parse(localStorage.getItem('active_deck') || "[]");

        function render() {
            // –†–µ–Ω–¥–µ—Ä 8 —Å–ª–æ—Ç–æ–≤
            const slotsContainer = document.getElementById('deck-slots');
            slotsContainer.innerHTML = "";
            for (let i = 0; i < 8; i++) {
                const card = activeDeck[i];
                const slot = document.createElement('div');
                slot.className = `slot ${card ? 'filled' : ''}`;
                slot.dataset.index = i;
                
                if (card) {
                    slot.innerHTML = `<div style="text-align:center"><b>${card.rating}</b><br>${card.name}</div>`;
                    slot.onclick = () => removeCard(i);
                } else {
                    slot.innerText = "–ü–£–°–¢–û";
                }
                slotsContainer.appendChild(slot);
            }

            // –†–µ–Ω–¥–µ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            const grid = document.getElementById('collection-grid');
            grid.innerHTML = "";
            collection.forEach(card => {
                const isInDeck = activeDeck.some(c => c.id === card.id);
                const cardEl = document.createElement('div');
                cardEl.className = `card ${isInDeck ? 'in-deck' : ''}`;
                cardEl.innerHTML = `<div class="rat">${card.rating}</div><div style="font-size:24px;">üë§</div><div>${card.name}</div>`;
                
                if(!isInDeck) {
                    addDragListeners(cardEl, card);
                }
                grid.appendChild(cardEl);
            });
        }

        function addDragListeners(el, cardData) {
            let startX, startY, initialX, initialY;

            el.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                const rect = el.getBoundingClientRect();
                startX = touch.clientX;
                startY = touch.clientY;
                initialX = rect.left;
                initialY = rect.top;
                
                el.classList.add('dragging');
                el.style.position = 'fixed';
                el.style.width = rect.width + 'px';
                moveAt(touch.clientX, touch.clientY);
            });

            el.addEventListener('touchmove', (e) => {
                moveAt(e.touches[0].clientX, e.touches[0].clientY);
            });

            el.addEventListener('touchend', (e) => {
                el.classList.remove('dragging');
                el.style.position = 'static';
                el.style.width = 'auto';

                const touch = e.changedTouches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const slot = target ? target.closest('.slot') : null;

                if (slot && activeDeck.length < 8) {
                    activeDeck.push(cardData);
                    localStorage.setItem('active_deck', JSON.stringify(activeDeck));
                }
                render();
            });

            function moveAt(x, y) {
                el.style.left = x - (el.offsetWidth / 2) + 'px';
                el.style.top = y - (el.offsetHeight / 2) + 'px';
            }
        }

        function removeCard(index) {
            activeDeck.splice(index, 1);
            localStorage.setItem('active_deck', JSON.stringify(activeDeck));
            render();
        }

        render();
    </script>
</body>
</html>