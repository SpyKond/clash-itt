<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–æ—Å—Ç–∞–≤—ã</title>
    <style>
        body { background: #050505; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        .active-deck-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
            width: 95%; max-width: 500px; background: #111; padding: 15px; 
            border-bottom: 2px solid #333; margin-top: 10px;
        }
        .slot { 
            aspect-ratio: 2/3; border: 2px dashed #444; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: #555;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .slot.filled { background: #002b2e; color: white; border-style: solid; }
        .slot.highlight { border-color: #00fbff; background: rgba(0, 251, 255, 0.1); }

        .collection-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
            gap: 10px; width: 95%; max-width: 600px; padding: 20px; padding-bottom: 100px;
        }
        .card { 
            background: #1a1a1a; border: 2px solid #333; border-radius: 8px; 
            padding: 8px; text-align: center; cursor: grab; position: relative;
            touch-action: none; z-index: 10;
        }
        .card.dragging { opacity: 0.8; cursor: grabbing; z-index: 1000; pointer-events: none; transform: scale(1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .card.in-deck { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        
        .rat { position: absolute; top: 2px; left: 4px; font-weight: bold; font-size: 12px; }
        .class-tag { font-size: 8px; color: #aaa; text-transform: uppercase; margin-top: 2px; }
        .btn-back { margin-top: 15px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 8px; }
    </style>
</head>
<body>

    <button class="btn-back" onclick="window.location.href='index.html'">–í –ú–ï–ù–Æ</button>

    <div class="active-deck-grid" id="deck-slots"></div>

    <h4 style="margin: 15px 0 0 0; color: #666; text-transform: uppercase; font-size: 12px;">–ö–æ–ª–ª–µ–∫—Ü–∏—è (—Ç—è–Ω–∏ –≤ —Å–ª–æ—Ç)</h4>
    <div class="collection-grid" id="collection-grid"></div>

    <script>
        let collection = JSON.parse(localStorage.getItem('my_collection') || "[]");
        let activeDeck = JSON.parse(localStorage.getItem('active_deck') || "[]");
        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –≤ –º–∞—Å—Å–∏–≤–µ 8 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–ø—É—Å—Ç—ã—Ö –∏–ª–∏ —Å –∫–∞—Ä—Ç–∞–º–∏)
        if (activeDeck.length === 0) activeDeck = new Array(8).fill(null);
        while (activeDeck.length < 8) activeDeck.push(null);

        function getRarityColor(rarity) {
            if(rarity === '–º–∏—Ñ–∏—á–µ—Å–∫–∏–π') return "#ff0000";
            if(rarity === '—ç–ø–∏—á–µ—Å–∫–∏–π') return "#e040fb";
            if(rarity === '—Ä–µ–¥–∫–∏–π') return "#2196F3";
            return "#ffffff";
        }

        function render() {
            const slotsContainer = document.getElementById('deck-slots');
            slotsContainer.innerHTML = "";
            
            for (let i = 0; i < 8; i++) {
                const card = activeDeck[i];
                const slot = document.createElement('div');
                slot.className = `slot ${card ? 'filled' : ''}`;
                slot.dataset.slotIndex = i; // –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–ª–∏ –¥—Ä–æ–ø–∞
                
                if (card) {
                    let color = getRarityColor(card.rarity);
                    slot.style.borderColor = color;
                    slot.style.boxShadow = `inset 0 0 10px ${color}44`;
                    slot.innerHTML = `
                        <div style="text-align:center">
                            <b style="color:gold">${card.rating}</b><br>
                            <small>${card.name}</small><br>
                            <div class="class-tag" style="color:white; font-size:7px">${card.class || ''}</div>
                        </div>`;
                    slot.onclick = () => removeCard(i);
                } else {
                    slot.innerText = "–ü–£–°–¢–û";
                    slot.style.borderColor = "#444";
                    slot.style.boxShadow = "none";
                }
                slotsContainer.appendChild(slot);
            }

            const grid = document.getElementById('collection-grid');
            grid.innerHTML = "";
            collection.forEach(card => {
                const isInDeck = activeDeck.some(c => c && c.id === card.id);
                const cardEl = document.createElement('div');
                cardEl.className = `card ${isInDeck ? 'in-deck' : ''}`;
                
                let color = getRarityColor(card.rarity);
                cardEl.style.borderColor = color;
                if(card.rarity === '–º–∏—Ñ–∏—á–µ—Å–∫–∏–π') cardEl.style.boxShadow = "0 0 10px #ff000055";

                cardEl.innerHTML = `
                    <div class="rat" style="color:${card.rarity==='–º–∏—Ñ–∏—á–µ—Å–∫–∏–π'?'#ff4444':'gold'}">${card.rating}</div>
                    <div style="font-size:24px;">üë§</div>
                    <div style="font-size:11px; font-weight:bold;">${card.name}</div>
                    <div class="class-tag">${card.class || '–ë–û–ï–¶'}</div>
                    <div style="font-size:9px; color:${color}">${card.rarity}</div>
                `;
                
                if(!isInDeck) addDragListeners(cardEl, card);
                grid.appendChild(cardEl);
            });
        }

        function addDragListeners(el, cardData) {
            let startX, startY;

            el.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                const rect = el.getBoundingClientRect();
                
                // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
                el.classList.add('dragging');
                el.style.position = 'fixed';
                el.style.width = rect.width + 'px';
                el.style.pointerEvents = 'none'; // –ö–†–ò–¢–ò–ß–ù–û: —á—Ç–æ–±—ã elementFromPoint –≤–∏–¥–µ–ª —Å–ª–æ—Ç –ø–æ–¥ –∫–∞—Ä—Ç–æ–π
                
                moveAt(touch.clientX, touch.clientY);
            });

            el.addEventListener('touchmove', (e) => {
                e.preventDefault(); // –ó–∞–ø—Ä–µ—Ç —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
                moveAt(e.touches[0].clientX, e.touches[0].clientY);
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–ª–æ—Ç–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                const target = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
                const slot = target ? target.closest('.slot') : null;
                
                document.querySelectorAll('.slot').forEach(s => s.classList.remove('highlight'));
                if (slot) slot.classList.add('highlight');
            });

            el.addEventListener('touchend', (e) => {
                el.classList.remove('dragging');
                el.style.position = 'static';
                el.style.width = 'auto';
                el.style.pointerEvents = 'auto';
                
                const touch = e.changedTouches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const slot = target ? target.closest('.slot') : null;

                if (slot) {
                    const idx = slot.dataset.slotIndex;
                    activeDeck[idx] = cardData; // –°—Ç–∞–≤–∏–º –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –º–µ—Å—Ç–æ (–∑–∞–º–µ–Ω—è–µ–º)
                    localStorage.setItem('active_deck', JSON.stringify(activeDeck));
                }
                
                render();
            });

            function moveAt(x, y) {
                el.style.left = x - (el.offsetWidth / 2) + 'px';
                el.style.top = y - (el.offsetHeight / 2) + 'px';
            }
        }

        function removeCard(index) {
            activeDeck[index] = null; // –î–µ–ª–∞–µ–º —Å–ª–æ—Ç –ø—É—Å—Ç—ã–º –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –º–∞—Å—Å–∏–≤–∞
            localStorage.setItem('active_deck', JSON.stringify(activeDeck));
            render();
        }

        render();
    </script>
</body>
</html>