<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clash Of IT - Battle</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; touch-action: none; display: flex; flex-direction: column; height: 100vh; }
        #game-ui { flex-grow: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #canvas-wrapper { position: relative; width: 100%; display: flex; justify-content: center; }
        canvas { background: #111; border: 3px solid #333; display: block; }
        #top-bar { height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #00fbff; background: #111; border-bottom: 2px solid #333; width: 100%; font-weight: bold; }
        
        #build-ui { position: absolute; bottom: 10px; display: none; gap: 5px; background: rgba(0,0,0,0.9); padding: 8px; border-radius: 12px; align-items: center; border: 1px solid #444; z-index: 50; flex-wrap: wrap; justify-content: center; width: 90%; }
        
        #controls-wrapper { min-height: 180px; background: #121212; display: none; flex-direction: column; align-items: center; gap: 8px; padding: 12px 5px; border-top: 3px solid #333; width: 100%; box-sizing: border-box; padding-bottom: 30px; }
        
        #elixir-row { display: flex; gap: 4px; margin-bottom: 5px; }
        .elixir-cell { width: 22px; height: 14px; background: #222; border: 1px solid #000; border-radius: 2px; position: relative; overflow: hidden; }
        .elixir-fill-inner { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: #e040fb; box-shadow: 0 0 10px #e040fb; }
        
        #hand-container { display: flex; gap: 8px; justify-content: center; width: 100%; max-width: 500px; }
        .card { width: 75px; height: 110px; background: linear-gradient(145deg, #333, #222); border: 3px solid #555; border-radius: 10px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; text-align: center; color: #fff; touch-action: none; overflow: hidden; }
        .card .cost { position: absolute; top: -4px; left: -4px; background: #e040fb; border-radius: 50%; width: 22px; height: 22px; line-height: 22px; border: 2px solid white; font-size: 12px; z-index: 10; font-weight: bold; }
        .card-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5; pointer-events: none; transition: height 0.1s linear; }
        
        .dragging-ghost { position: fixed; width: 75px; height: 110px; border: 2px solid #00fbff; background: rgba(34,34,34,0.9); border-radius: 10px; z-index: 1000; pointer-events: none; opacity: 0.8; box-shadow: 0 0 15px #00fbff; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; }

        #countdown { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; font-size: 80px; background: rgba(0,0,0,0.5); z-index: 2000; color: #00fbff; font-weight: bold; }
        #game-msg-box { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); z-index: 9999; }
        .btn { padding: 8px 10px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; font-size: 9px; text-transform: uppercase; }

        #lobby-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .lobby-window { background: #222; padding: 25px; border: 2px solid #444; border-radius: 15px; text-align: center; width: 300px; }
    </style>
</head>
<body>

<div id="lobby-overlay">
    <div id="lobby-choice" class="lobby-window">
        <h2>Clash Of IT</h2>
        <button class="btn" style="background:#4CAF50; padding:15px; width:100%; margin-bottom:10px;" onclick="startBotMode()">ПРОТИВ БОТА</button>
        <button class="btn" style="background:#2196F3; padding:15px; width:100%;" onclick="openLobbyMenu()">ЛОББИ 1 НА 1</button>
    </div>
    <div id="lobby-main" class="lobby-window" style="display:none;">
        <h3>ВАШ ID:</h3>
        <div id="my-id-display" style="color:#00fbff; margin:10px; font-family:monospace;">...</div>
        <input type="text" id="friend-id-input" placeholder="ID ДРУГА" style="width:80%; padding:8px; margin-bottom:10px;">
        <button class="btn" style="background:#2196F3; width:100%;" onclick="connectToFriend()">ИГРАТЬ С ДРУГОМ</button>
    </div>
</div>

<div id="top-bar">03:00</div>
<div id="game-ui">
    <div id="canvas-wrapper">
        <canvas id="canvas"></canvas>
        <div id="build-ui">
            <div id="wall-dock" style="width:30px; height:10px; background:#888; border:2px solid #fff;" onpointerdown="startWallDrag()"></div>
            <span style="font-size: 10px;">СТЕНЫ: <span id="wall-rem">7</span></span>
            <button class="btn" style="background:#2196F3" onclick="handleRotate()">ПОВЕРНУТЬ</button>
            <button class="btn" style="background:#4CAF50" onclick="confirmReady()">В БОЙ!</button>
        </div>
    </div>
</div>

<div id="controls-wrapper">
    <div style="font-size: 14px; color: #e040fb; font-weight: bold;">ЭЛИКСИР: <span id="elixir-val">0</span></div>
    <div id="elixir-row"></div>
    <div id="hand-container"></div>
</div>

<div id="countdown">3</div>
<div id="game-msg-box">
    <div id="game-msg-text" style="font-size: 40px; color: #ffeb3b; margin-bottom: 20px;"></div>
    <button class="btn" style="background:#2196F3; padding:15px 40px; font-size:20px;" onclick="goToMenu()">В МЕНЮ</button>
</div>

<script src="assets.js"></script>
<script>
// --- БЛОКИРОВКА НАЗАД ---
window.history.pushState(null, "", window.location.href);
window.onpopstate = function() { window.history.pushState(null, "", window.location.href); };

// --- ГЕЙМПЛЕЙНЫЕ КОНСТАНТЫ (БЕЗ ИЗМЕНЕНИЙ) ---
const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
const BW = 500, BH = 900, ROWS = 16, COLS = 8, cellW = BW / COLS, cellH = BH / ROWS;
let elixir = 0, gameActive = false, isBuilding = false, hand = [], units = [], towers = [], walls = [], fx = [];
let deckPool = [], ghostCard = null, draggingCardIdx = null, dpr = window.devicePixelRatio || 1, scale = 1;

const CLASS_STATS = {
    'танк': { cost: 5, hp: 1300, damage: 160, speed: 0.5, size: 22, range: 45, color: '#444' },
    'лучник': { cost: 3, hp: 180, damage: 30, speed: 0.9, size: 12, range: 180, color: '#e91e63', canAttackAir: true },
    'ближник': { cost: 2, hp: 350, damage: 35, speed: 1.3, size: 14, range: 45, color: '#ff9800' },
    'армия': { cost: 3, hp: 50, damage: 12, speed: 1.4, size: 8, range: 35, isSwarm: true, count: 4, color: '#795548' },
    'летун': { cost: 4, hp: 160, damage: 40, speed: 0.8, size: 14, range: 170, color: '#00fbff', isAir: true, canAttackAir: true },
    'медик': { cost: 4, hp: 220, damage: 0, speed: 1.0, size: 13, range: 150, isHealer: true, color: '#4caf50' }
};

// --- УМНАЯ КОЛОДА ---
function getCard() {
    let activeDeck = JSON.parse(localStorage.getItem('active_deck') || "[]").filter(c => c !== null);
    if(activeDeck.length === 0) return null;

    if (deckPool.length === 0) {
        deckPool = [...activeDeck].sort(() => Math.random() - 0.5);
    }

    let cardIdx = -1;
    // Старт игры: ищем карту за 2-3 эликсира
    if (hand.filter(c => c).length < 2) {
        cardIdx = deckPool.findIndex(c => (CLASS_STATS[c.class.toLowerCase()]?.cost || 9) <= 3);
    }
    if (cardIdx === -1) cardIdx = 0;

    let data = deckPool.splice(cardIdx, 1)[0];
    let base = CLASS_STATS[data.class.toLowerCase()] || CLASS_STATS['ближник'];
    return { ...base, ...data, curHp: base.hp, type: data.class.toUpperCase() };
}

function startGame() {
    isBuilding = true; document.getElementById('build-ui').style.display = 'flex';
    towers = [
        { x: BW/2, y: BH-80, hp: 2000, maxHp: 2000, side: 'player', size: 30, range: 140, canAttackAir: true },
        { x: BW/2, y: 80, hp: 2000, maxHp: 2000, side: 'enemy', size: 30, range: 140, canAttackAir: true }
    ];
    resize(); renderLoop();
}

function confirmReady() {
    isBuilding = false; document.getElementById('build-ui').style.display = 'none';
    document.getElementById('countdown').style.display = 'flex';
    let c = 3;
    let t = setInterval(() => {
        c--;
        if(c > 0) document.getElementById('countdown').innerText = c;
        else { 
            clearInterval(t); document.getElementById('countdown').style.display = 'none'; 
            gameActive = true; document.getElementById('controls-wrapper').style.display = 'flex';
            hand = []; for(let i=0; i<4; i++) hand.push(getCard()); renderHand();
        }
    }, 1000);
}

function updateGame() {
    elixir = Math.min(10, elixir + 0.0075);
    document.getElementById('elixir-val').innerText = Math.floor(elixir);
    
    // Эликсир-бар
    document.querySelectorAll('.elixir-fill-inner').forEach((f, i) => {
        f.style.width = Math.max(0, Math.min(1, elixir - i)) * 100 + "%";
    });

    // ПЛАВНОЕ КД
    hand.forEach((c, i) => {
        let ov = document.getElementById(`ov-${i}`);
        if(ov) {
            let p = Math.max(0, Math.min(100, (1 - elixir / c.cost) * 100));
            ov.style.height = p + "%";
        }
    });

    // ЛОГИКА БОЯ (БЕЗ ИЗМЕНЕНИЙ)
    units = units.filter(u => u.curHp > 0);
    [...units, ...towers].forEach(u => {
        let targets = [...units, ...towers].filter(t => t.side !== u.side && t.curHp > 0);
        if(!u.canAttackAir) targets = targets.filter(t => !t.isAir);
        let target = targets.sort((a,b) => Math.hypot(a.x-u.x, a.y-u.y) - Math.hypot(b.x-u.x, b.y-u.y))[0];
        
        if(target && Math.hypot(target.x-u.x, target.y-u.y) < (u.range || 50)) {
            if(Date.now() - (u.l || 0) > 1000) {
                target.curHp -= (u.damage || 20); u.l = Date.now();
                fx.push({x1:u.x, y1:u.y, x2:target.x, y2:target.y, t:5});
            }
        } else if(u.speed) {
            u.y += u.speed * (u.side === 'player' ? -1 : 1);
        }
    });
    if(towers[0].curHp <= 0) endGame("LOSE"); if(towers[1].curHp <= 0) endGame("WIN");
}

function renderLoop() {
    ctx.clearRect(0,0, canvas.width, canvas.height); const s = scale * dpr;
    
    // СЕТКА И ЛИНИЯ
    ctx.strokeStyle = "rgba(255,255,255,0.05)"; ctx.lineWidth = dpr;
    for(let i=0; i<=COLS; i++) { ctx.beginPath(); ctx.moveTo(i*cellW*s,0); ctx.lineTo(i*cellW*s,BH*s); ctx.stroke(); }
    for(let j=0; j<=ROWS; j++) { ctx.beginPath(); ctx.moveTo(0,j*cellH*s); ctx.lineTo(BW*s,j*cellH*s); ctx.stroke(); }
    ctx.strokeStyle = "rgba(0,251,255,0.3)"; ctx.beginPath(); ctx.moveTo(0, (BH/2)*s); ctx.lineTo(BW*s, (BH/2)*s); ctx.stroke();

    [...towers, ...units].forEach(u => {
        if(u.curHp <= 0) return;
        ctx.fillStyle = u.side === 'player' ? (u.color || '#2196F3') : '#f44336';
        ctx.beginPath(); ctx.arc(u.x*s, u.y*s, (u.size||20)*s, 0, 7); ctx.fill();
        // ХП БАР
        ctx.fillStyle = "#000"; ctx.fillRect((u.x-20)*s, (u.y-35)*s, 40*s, 4*s);
        ctx.fillStyle = "#4CAF50"; ctx.fillRect((u.x-20)*s, (u.y-35)*s, (40*(u.curHp/(u.hp||u.maxHp)))*s, 4*s);
    });
    if(gameActive) updateGame();
    requestAnimationFrame(renderLoop);
}

function renderHand() {
    let c = document.getElementById('hand-container'); c.innerHTML = '';
    hand.forEach((card, i) => {
        let d = document.createElement('div'); d.className = 'card';
        d.innerHTML = `<div id="ov-${i}" class="card-overlay"></div><div class="cost">${card.cost}</div><small>${card.name}</small>`;
        d.ontouchstart = (e) => {
            if(elixir < card.cost) return;
            draggingCardIdx = i;
            ghostCard = document.createElement('div');
            ghostCard.className = 'dragging-ghost'; ghostCard.innerText = card.name;
            document.body.appendChild(ghostCard);
            updateGhost(e.touches[0]);
        };
        c.appendChild(d);
    });
}

function updateGhost(t) { if(ghostCard) { ghostCard.style.left = t.clientX-37+'px'; ghostCard.style.top = t.clientY-55+'px'; } }
window.ontouchmove = (e) => updateGhost(e.touches[0]);
window.ontouchend = (e) => {
    if(draggingCardIdx !== null) {
        let rect = canvas.getBoundingClientRect();
        let x = (e.changedTouches[0].clientX - rect.left) / scale;
        let y = (e.changedTouches[0].clientY - rect.top) / scale;
        if(y > BH/2 && y < BH && elixir >= hand[draggingCardIdx].cost) {
            let c = hand[draggingCardIdx];
            units.push({...c, x, y, side: 'player'});
            elixir -= c.cost; hand[draggingCardIdx] = getCard(); renderHand();
        }
    }
    if(ghostCard) { ghostCard.remove(); ghostCard = null; }
    draggingCardIdx = null;
};

function resize() { scale = Math.min(window.innerWidth/BW, (window.innerHeight-250)/BH); canvas.width = BW*scale*dpr; canvas.height = BH*scale*dpr; canvas.style.width = BW*scale+'px'; canvas.style.height = BH*scale+'px'; }
function startBotMode() { document.getElementById('lobby-overlay').style.display='none'; startGame(); }
function goToMenu() { window.location.reload(); }
function endGame(m) { gameActive = false; document.getElementById('game-msg-box').style.display='flex'; document.getElementById('game-msg-text').innerText = m; }
window.onresize = resize;
</script>
</body>
</html>